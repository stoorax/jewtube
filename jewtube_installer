# JewTube Environment Installer (Portable Version)
# Installiert alles in einem isolierten Verzeichnis für einfache Deinstallation

$INSTALL_DIR = "jewtube_env"
$PYTHON_VERSION = "3.11.9"
$PYTHON_URL = "https://www.python.org/ftp/python/$PYTHON_VERSION/python-$PYTHON_VERSION-embed-amd64.zip"
$PIP_URL = "https://bootstrap.pypa.io/get-pip.py"

# 1. Installationsverzeichnis erstellen
Write-Host "`nErstelle Installationsverzeichnis: $INSTALL_DIR" -ForegroundColor Cyan
if (Test-Path $INSTALL_DIR) {
    Remove-Item $INSTALL_DIR -Recurse -Force -ErrorAction SilentlyContinue
}
New-Item -ItemType Directory -Path $INSTALL_DIR | Out-Null
Set-Location $INSTALL_DIR

# 2. Python herunterladen und entpacken
Write-Host "Lade Python $PYTHON_VERSION herunter..." -ForegroundColor Cyan
$pythonZip = "python_embedded.zip"
Invoke-WebRequest -Uri $PYTHON_URL -OutFile $pythonZip -UseBasicParsing

Write-Host "Entpacke Python..." -ForegroundColor Cyan
Expand-Archive -Path $pythonZip -DestinationPath .
Remove-Item $pythonZip -Force

# 3. Python Umgebung konfigurieren
Write-Host "Konfiguriere Python Umgebung..." -ForegroundColor Cyan
# Füge ._pth Datei hinzu für Modulpfade
Set-Content -Path "python._pth" -Value @"
python${PYTHON_VERSION}.zip
.
import site
"@

# 4. PIP installieren
Write-Host "Installiere pip..." -ForegroundColor Cyan
Invoke-WebRequest -Uri $PIP_URL -OutFile "get-pip.py" -UseBasicParsing
.\python.exe get-pip.py
Remove-Item get-pip.py -Force

# 5. Pakete in isolierter Umgebung installieren
Write-Host "Installiere erforderliche Pakete..." -ForegroundColor Cyan
$packages = "yt-dlp", "ytmusicapi", "browser_cookie3"
.\python.exe -m pip install $packages

# 6. Startskript erstellen
Write-Host "Erstelle Startskript..." -ForegroundColor Cyan
$launcherContent = @"
@echo off
setlocal
set PYTHONPATH=%~dp0
%~dp0python.exe -m yt_dlp %*
endlocal
"@

Set-Content -Path "jewtube.bat" -Value $launcherContent

# 7. Erfolgsmeldung und Anleitung
Write-Host "`nJewTube-Umgebung erfolgreich installiert!" -ForegroundColor Green
Write-Host "Installationsverzeichnis: $PWD" -ForegroundColor Green
Write-Host "`nSo verwenden Sie JewTube:" -ForegroundColor Yellow
Write-Host "1. Führen Sie das Startskript aus: .\jewtube.bat"
Write-Host "2. Oder verwenden Sie direkt: .\python.exe -m yt_dlp [OPTIONS] URL"
Write-Host "`nDeinstallation: Löschen Sie einfach den gesamten '$INSTALL_DIR' Ordner" -ForegroundColor Cyan

# 8. Sicherheitsabfrage
$choice = Read-Host "`nInstallation erfolgreich? (J = Beenden, N = Verzeichnis löschen)"
if ($choice -eq "N" -or $choice -eq "n") {
    Write-Host "Entferne Installationsverzeichnis..." -ForegroundColor Yellow
    Set-Location ..
    Remove-Item $INSTALL_DIR -Recurse -Force
    Write-Host "Installation vollständig zurückgerollt!" -ForegroundColor Green
}
else {
    Write-Host "Installation abgeschlossen. Viel Spaß mit JewTube!" -ForegroundColor Green
}
