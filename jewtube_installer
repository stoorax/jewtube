# JewTube Environment Installer (Fixed Version)
# Behebt das yt-dlp Modul-Problem

$INSTALL_DIR = "jewtube_env"
$PYTHON_VERSION = "3.11.9"
$PYTHON_URL = "https://www.python.org/ftp/python/$PYTHON_VERSION/python-$PYTHON_VERSION-embed-amd64.zip"
$PIP_URL = "https://bootstrap.pypa.io/get-pip.py"

# 1. Verzeichnis vorbereiten
Write-Host "`n=== JewTube Installation ===" -ForegroundColor Cyan
if (Test-Path $INSTALL_DIR) {
    Remove-Item $INSTALL_DIR -Recurse -Force
}
New-Item -ItemType Directory -Path $INSTALL_DIR | Out-Null
Set-Location $INSTALL_DIR

try {
    # 2. Python herunterladen
    Write-Host "Lade Python $PYTHON_VERSION..." -ForegroundColor Yellow
    $pythonZip = "python.zip"
    Invoke-WebRequest -Uri $PYTHON_URL -OutFile $pythonZip -UseBasicParsing
    Expand-Archive -Path $pythonZip -DestinationPath .
    Remove-Item $pythonZip -Force

    # 3. WICHTIG: python._pth Datei anpassen
    Write-Host "Konfiguriere Python..." -ForegroundColor Yellow
    Set-Content -Path "python._pth" @"
python${PYTHON_VERSION}.zip
.
import site
Lib\site-packages
"@

    # 4. Pip installieren
    Write-Host "Installiere pip..." -ForegroundColor Yellow
    Invoke-WebRequest -Uri $PIP_URL -OutFile "get-pip.py" -UseBasicParsing
    .\python.exe get-pip.py --no-warn-script-location
    Remove-Item get-pip.py -Force

    # 5. Pakete installieren (mit explizitem Zielverzeichnis)
    Write-Host "Installiere Pakete..." -ForegroundColor Yellow
    New-Item -ItemType Directory -Path "Lib\site-packages" -Force | Out-Null
    .\python.exe -m pip install yt-dlp ytmusicapi browser_cookie3 --target="Lib\site-packages" --no-warn-script-location

    # 6. Startskript erstellen
    Write-Host "Erstelle Startskript..." -ForegroundColor Yellow
    Set-Content -Path "jewtube.bat" @"
@echo off
set PYTHONPATH=%~dp0
%~dp0python.exe -m yt_dlp %*
"@

    # Erfolgsmeldung
    Write-Host "`n=== Installation erfolgreich! ===" -ForegroundColor Green
    Write-Host "Testen Sie mit: .\jewtube.bat --version" -ForegroundColor Cyan
}
catch {
    Write-Host "`nFEHLER: $_" -ForegroundColor Red
    Write-Host "Entferne Installationsverzeichnis..." -ForegroundColor Yellow
    Set-Location ..
    Remove-Item $INSTALL_DIR -Recurse -Force -ErrorAction SilentlyContinue
    exit 1
}

Write-Host "`nDeinstallation: LÃ¶schen Sie einfach den '$INSTALL_DIR' Ordner" -ForegroundColor Cyan
