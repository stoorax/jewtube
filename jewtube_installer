# JewTube One-Click Installer (komprimierte URL-Version)
# Ausf√ºhrung mit: irm https://raw.githubusercontent.com/stoorax/jewtube/main/jewtube_installer | iex

# Admin-Check und Auto-Restart
if (-NOT ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    $scriptUrl = "https://raw.githubusercontent.com/stoorax/jewtube/main/jewtube_installer"
    Start-Process powershell -Verb RunAs -ArgumentList "-NoProfile -ExecutionPolicy Bypass -Command `"irm '$scriptUrl' | iex`""
    exit
}

### AB HIER L√ÑUFT ALS ADMIN ###

# 1. Winget sicher installieren
if (-not (Get-Command winget -ErrorAction SilentlyContinue)) {
    Write-Host "üîß Winget wird installiert..." -ForegroundColor Cyan
    try {
        $progressPreference = 'silentlyContinue'
        irm https://aka.ms/getwinget -OutFile winget.msixbundle -UseBasicParsing
        Add-AppxPackage -Path winget.msixbundle
        Remove-Item winget.msixbundle -ErrorAction SilentlyContinue
    }
    catch {
        Write-Host "‚ùå Winget-Installation fehlgeschlagen" -ForegroundColor Red
        exit 1
    }
}

# 2. Python 3.11 installieren
if (-not (Get-Command python -ErrorAction SilentlyContinue)) {
    Write-Host "üêç Python 3.11 wird installiert..." -ForegroundColor Cyan
    winget install --id Python.Python.3.11 --exact --accept-source-agreements --accept-package-agreements
    # PATH aktualisieren
    $env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")
}

# 3. Pakete installieren
$packages = @("yt-dlp", "ytmusicapi", "browser-cookie3")
Write-Host "üì¶ Installiere Pakete..." -ForegroundColor Cyan

python -m ensurepip --upgrade
foreach ($pkg in $packages) {
    python -m pip install --upgrade $pkg
    if ($LASTEXITCODE -ne 0) { Write-Host "‚ö†Ô∏è Problem mit $pkg" -ForegroundColor Yellow }
}

# 4. Verifikation
Write-Host "`nüîç √úberpr√ºfe Installation:" -ForegroundColor Green
try {
    python -c "import yt_dlp; print(f'‚úÖ yt-dlp {yt_dlp.__version__}')"
    python -c "import ytmusicapi; print(f'‚úÖ ytmusicapi {ytmusicapi.__version__}')"
    python -c "import browser_cookie3; print('‚úÖ browser-cookie3')"
}
catch {
    Write-Host "‚ùå Verifikation fehlgeschlagen: $_" -ForegroundColor Red
    exit 1
}

Write-Host "`nüéâ Installation erfolgreich!" -ForegroundColor Green
Write-Host "Verwendung: python -m yt_dlp [URL]" -ForegroundColor Cyan
Write-Host "Deinstallieren: pip uninstall yt-dlp ytmusicapi browser-cookie3" -ForegroundColor DarkGray
