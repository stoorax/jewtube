# JewTube Installer (Finale Version)
# Ausf√ºhrung mit: irm https://raw.githubusercontent.com/stoorax/jewtube/main/jewtube_installer | iex

function Install-PythonWithWinget {
    # Installiert Python 3.11 mit winget und stellt sicher, dass es im PATH ist
    Write-Host "Installiere Python mit winget..." -ForegroundColor Cyan
    
    # F√ºhre winget install aus und warte auf Abschluss
    $process = Start-Process -FilePath "winget" -ArgumentList @(
        "install",
        "--id=Python.Python.3.11",
        "--exact",
        "--accept-source-agreements",
        "--accept-package-agreements",
        "--silent"
    ) -Wait -PassThru -NoNewWindow
    
    if ($process.ExitCode -ne 0) {
        throw "Python-Installation fehlgeschlagen mit Exit-Code $($process.ExitCode)"
    }
    
    # Aktualisiere den PATH
    $env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + 
                [System.Environment]::GetEnvironmentVariable("Path", "User")
    
    # Finde den Python-Pfad
    $pythonPath = @(
        "$env:LocalAppData\Programs\Python\Python311\python.exe",
        "C:\Program Files\Python311\python.exe"
    ) | Where-Object { Test-Path $_ } | Select-Object -First 1
    
    if (-not $pythonPath) {
        throw "Python wurde installiert, aber Pfad nicht gefunden"
    }
    
    return $pythonPath
}

function Write-Step {
    param($step, $message)
    Write-Host "`n=====[ SCHRITT $step ]=====" -ForegroundColor Magenta
    Write-Host $message -ForegroundColor Cyan
}

# Admin-Check
$adminCheck = [Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()
if (-NOT $adminCheck.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Write-Host "`n‚ö†Ô∏è ADMIN-REICHTE ERFORDERLICH" -ForegroundColor Red
    Write-Host "Das Skript wird sich neu starten..." -ForegroundColor Yellow
    
    $scriptUrl = "https://raw.githubusercontent.com/stoorax/jewtube/main/jewtube_installer"
    $command = "Start-Process powershell -Verb RunAs -ArgumentList '-NoExit -Command \"irm $scriptUrl | iex\"'"
    Invoke-Expression $command
    exit
}

### HAUPTPROGRAMM ###
try {
    # 1. Winget Installation
    Write-Step -step 1 -message "√úberpr√ºfe winget"
    if (-not (Get-Command winget -ErrorAction SilentlyContinue)) {
        Write-Host "Installiere winget..." -ForegroundColor Yellow
        $tempFile = "$env:TEMP\winget_install.msixbundle"
        
        try {
            Invoke-WebRequest -Uri https://aka.ms/getwinget -OutFile $tempFile -UseBasicParsing
            Add-AppxPackage -Path $tempFile -ErrorAction Stop
        }
        catch {
            throw "Winget-Installation fehlgeschlagen: $_"
        }
        finally {
            Remove-Item $tempFile -ErrorAction SilentlyContinue
        }
    }
    else {
        Write-Host "Winget ist installiert" -ForegroundColor Green
    }

    # 2. Python Installation
    Write-Step -step 2 -message "√úberpr√ºfe Python 3.11"
    $pythonExe = $null
    
    # Versuche Python zu finden
    $pythonExe = @(
        "$env:LocalAppData\Programs\Python\Python311\python.exe",
        "C:\Program Files\Python311\python.exe",
        (Get-Command python -ErrorAction SilentlyContinue).Source
    ) | Where-Object { $_ -and (Test-Path $_) } | Select-Object -First 1

    if (-not $pythonExe) {
        Write-Host "Python nicht gefunden, installiere..." -ForegroundColor Yellow
        $pythonExe = Install-PythonWithWinget
        Write-Host "‚úÖ Python installiert: $pythonExe" -ForegroundColor Green
    }
    else {
        Write-Host "Python gefunden: $pythonExe" -ForegroundColor Green
        Write-Host "Version: $(& `"$pythonExe`" --version 2>&1)" -ForegroundColor Green
    }

    # 3. Pakete installieren
    Write-Step -step 3 -message "Installiere ben√∂tigte Pakete"
    $packages = @("yt-dlp", "ytmusicapi", "browser-cookie3")
    
    foreach ($pkg in $packages) {
        Write-Host "`nüîÑ Installiere $pkg..." -ForegroundColor Blue
        & `"$pythonExe`" -m pip install --upgrade $pkg --disable-pip-version-check
        
        # Verifiziere Installation
        $pkgName = $pkg.Replace('-', '_')
        $testResult = & `"$pythonExe`" -c "import $pkgName; print('‚úÖ Erfolgreich')" 2>&1
        Write-Host $testResult -ForegroundColor Green
    }

    # 4. Abschluss
    Write-Step -step 4 -message "Installation abgeschlossen"
    Write-Host "`nüéâ JEWTUBE ERFOLGREICH INSTALLIERT" -ForegroundColor Green
    
    Write-Host "`nSysteminformationen:" -ForegroundColor Cyan
    Write-Host "Python: $(& `"$pythonExe`" --version 2>&1)" -ForegroundColor Gray
    Write-Host "yt-dlp: $(& `"$pythonExe`" -c 'import yt_dlp; print(yt_dlp.__version__)' 2>&1)" -ForegroundColor Gray
    Write-Host "ytmusicapi: $(& `"$pythonExe`" -c 'import ytmusicapi; print(ytmusicapi.__version__)' 2>&1)" -ForegroundColor Gray
    
    Write-Host "`nVerf√ºgbare Kommandos:" -ForegroundColor Cyan
    Write-Host "‚Ä¢ & `"$pythonExe`" -m yt_dlp [URL]" -ForegroundColor White
    Write-Host "‚Ä¢ & `"$pythonExe`" -m ytmusicapi" -ForegroundColor White
}
catch {
    Write-Host "`n‚ùå‚ùå‚ùå FEHLER: $_" -ForegroundColor Red
    $errorOccurred = $true
}

# Warte auf Benutzereingabe
Write-Host "`n========================================" -ForegroundColor DarkGray
if ($errorOccurred) {
    Write-Host " INSTALLATION FEHLGESCHLAGEN " -BackgroundColor Red -ForegroundColor White
}
else {
    Write-Host " INSTALLATION ERFOLGREICH " -BackgroundColor Green -ForegroundColor Black
}
Write-Host "========================================" -ForegroundColor DarkGray

Write-Host "`nDr√ºcken Sie ENTER um das Fenster zu schlie√üen..." -ForegroundColor Yellow
[void][System.Console]::ReadLine()
