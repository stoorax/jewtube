# JewTube ULTIMATE Installer
# Behebt alle Pip- und Modul-Probleme

$ErrorActionPreference = "Stop"

# 1. Setup
$INSTALL_DIR = "$PWD\jewtube_env"
$PYTHON_VERSION = "3.11.9"
$PYTHON_URL = "https://www.python.org/ftp/python/$PYTHON_VERSION/python-$PYTHON_VERSION-embed-amd64.zip"
$PIP_URL = "https://bootstrap.pypa.io/get-pip.py"

Write-Host "`n=== JewTube ULTIMATE Installation ===" -ForegroundColor Cyan
Write-Host "Zielverzeichnis: $INSTALL_DIR" -ForegroundColor Yellow

# 2. Clean install
if (Test-Path $INSTALL_DIR) {
    Write-Host "Entferne alte Installation..." -ForegroundColor Yellow
    Remove-Item $INSTALL_DIR -Recurse -Force
}

New-Item -ItemType Directory -Path $INSTALL_DIR | Out-Null
Push-Location $INSTALL_DIR

try {
    # 3. Download and extract Python
    Write-Host "Lade Python herunter..." -ForegroundColor Cyan
    Invoke-WebRequest -Uri $PYTHON_URL -OutFile "python.zip" -UseBasicParsing
    Expand-Archive -Path "python.zip" -DestinationPath .
    Remove-Item "python.zip" -Force

    # 4. Fix critical Python configuration
    Write-Host "Konfiguriere Python..." -ForegroundColor Cyan
    New-Item -ItemType Directory -Path "Lib\site-packages" -Force | Out-Null
    
    # Create proper ._pth file
    Set-Content -Path "python._pth" @"
python${PYTHON_VERSION}.zip
.
Lib\site-packages
import site
"@

    # 5. PROPER pip installation
    Write-Host "Installiere pip KORREKT..." -ForegroundColor Cyan
    Invoke-WebRequest -Uri $PIP_URL -OutFile "get-pip.py" -UseBasicParsing
    
    # First install pip to the local environment
    $env:PYTHONPATH = "$PWD\Lib\site-packages"
    .\python.exe get-pip.py --no-warn-script-location --target="Lib\site-packages"
    
    # Verify pip is working
    if (-not (Test-Path "Lib\site-packages\pip")) {
        throw "Pip-Installation fehlgeschlagen"
    }
    Remove-Item "get-pip.py" -Force

    # 6. Install packages with PROPER pip
    Write-Host "Installiere Pakete..." -ForegroundColor Cyan
    .\python.exe -m pip install --target="Lib\site-packages" --no-warn-script-location yt-dlp ytmusicapi browser_cookie3
    
    # 7. Verify installation
    Write-Host "Teste Installation..." -ForegroundColor Cyan
    $test = .\python.exe -c "import yt_dlp; print(yt_dlp.__version__)" 2>&1
    if ($LASTEXITCODE -ne 0) {
        throw "Test fehlgeschlagen: $test"
    }

    # 8. Create launcher
    Write-Host "Erstelle Startskript..." -ForegroundColor Cyan
    Set-Content -Path "jewtube.bat" @"
@echo off
set PYTHONPATH=%~dp0Lib\site-packages
%~dp0python.exe -m yt_dlp %*
"@

    # Success message
    Write-Host "`n=== ERFOLGREICH INSTALLIERT ===" -ForegroundColor Green
    Write-Host "Getestete Version: $test" -ForegroundColor Green
    Write-Host "`nNUTZUNG:" -ForegroundColor Yellow
    Write-Host "1. .\jewtube_env\jewtube.bat [OPTIONS] URL"
    Write-Host "2. .\jewtube_env\python.exe -m yt_dlp [OPTIONS] URL"
    Write-Host "`nDEINSTALLATION: Einfach den Ordner '$INSTALL_DIR' löschen" -ForegroundColor Cyan
}
catch {
    Write-Host "`nFEHLER: $_" -ForegroundColor Red
    Write-Host "Führe Cleanup durch..." -ForegroundColor Yellow
    Pop-Location
    Remove-Item $INSTALL_DIR -Recurse -Force -ErrorAction SilentlyContinue
    exit 1
}
finally {
    Pop-Location
}

Write-Host "`nFertig! Das Skript kann jetzt verwendet werden." -ForegroundColor Green
