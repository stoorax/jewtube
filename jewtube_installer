# JewTube Environment Installer
# Stellt sicher, dass Python 3.8+, pip, yt-dlp, ytmusicapi und browser_cookie3 installiert sind

# Prüft Administratorrechte (für Python-Installation erforderlich)
$isAdmin = ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)

# Funktion zum Installieren von Python
function Install-Python {
    $pythonURL = "https://www.python.org/ftp/python/3.11.9/python-3.11.9-amd64.exe"
    $installerPath = "$env:TEMP\python_installer.exe"

    try {
        # Installer herunterladen
        Invoke-WebRequest -Uri $pythonURL -OutFile $installerPath -UseBasicParsing
        
        # Python im Silent Mode installieren (für alle Benutzer mit Admin-Rechten)
        $installArgs = "/quiet InstallAllUsers=1 PrependPath=1"
        Start-Process -FilePath $installerPath -ArgumentList $installArgs -Wait
        
        # PATH-Variable aktualisieren
        $env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")
    }
    finally {
        # Installer aufräumen
        if (Test-Path $installerPath) {
            Remove-Item $installerPath -Force
        }
    }
}

# Funktion zum Prüfen der Python-Version
function Test-PythonVersion {
    try {
        $pythonVersion = (python --version 2>&1 | Select-String -Pattern "Python (\d+\.\d+)").Matches.Groups[1].Value
        return [version]$pythonVersion -ge [version]"3.8"
    }
    catch {
        return $false
    }
}

# Hauptinstallation
try {
    # 1. Python prüfen und installieren
    if (-not (Test-PythonVersion)) {
        Write-Host "Python 3.8+ wird installiert..." -ForegroundColor Yellow
        
        if (-not $isAdmin) {
            Write-Host "FEHLER: Administratorrechte erforderlich!" -ForegroundColor Red
            Write-Host "Bitte PowerShell als Administrator ausführen und Skript erneut starten" -ForegroundColor Yellow
            exit 1
        }
        
        Install-Python
        
        # Nach Installation erneut prüfen
        if (-not (Test-PythonVersion)) {
            Write-Host "Python-Installation fehlgeschlagen!" -ForegroundColor Red
            exit 1
        }
    }

    # 2. Pakete mit pip installieren
    Write-Host "Installiere erforderliche Python-Pakete..." -ForegroundColor Cyan
    python -m pip install --upgrade pip
    python -m pip install yt-dlp ytmusicapi browser_cookie3
    
    # 3. Erfolgsmeldung
    Write-Host "`nJewTube-Environment erfolgreich installiert!" -ForegroundColor Green
    Write-Host "Folgende Pakete sind jetzt verfügbar:" -ForegroundColor Green
    python -m pip list | Select-String -Pattern "(yt-dlp|ytmusicapi|browser_cookie3)"
}
catch {
    Write-Host "`nFEHLER bei der Installation: $_" -ForegroundColor Red
    exit 1
}
